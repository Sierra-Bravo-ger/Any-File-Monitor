<!DOCTYPE html>
<html lang="de">
<!-- Modular version of AFM Dashboard -->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <title>AnyFileMonitor Dashboard</title>
  
  <!-- PWA Support -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3f51b5">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="AFM Dashboard">
  <link rel="apple-touch-icon" href="images/icon-152x152.png">

  <!-- Material Design Lite -->
  <link rel="stylesheet" href="libs/fonts/material-icons.css">
  <link rel="stylesheet" href="libs/css/material.indigo-pink.min.css">
  <script defer src="libs/js/material.min.js"></script>
  <!-- PapaParse für CSV-Parsing -->
  <script src="libs/js/papaparse.min.js"></script>
  <!-- Chart.js für Diagramme -->
  <script src="libs/js/chart.js"></script>
  <script src="libs/js/chartjs-chart-matrix.min.js"></script>
  <script src="libs/js/chartjs-plugin-datalabels.js"></script>
  <!-- Moment.js für Datumsfunktionen -->
  <script src="libs/js/moment.min.js"></script>
  <script src="libs/js/moment-de.js"></script>
  <!-- noUiSlider für den Zeitraum-Slider -->
  <link rel="stylesheet" href="libs/css/nouislider.min.css">
  <script src="libs/js/nouislider.min.js"></script>
  
  <!-- Modular CSS -->
  <link rel="stylesheet" href="styles/styles.css">
  <link rel="stylesheet" href="styles/lastUpdate.css">
  <link rel="stylesheet" href="styles/errorList.css">
  <link rel="stylesheet" href="styles/quickFilter.css">
  <link rel="stylesheet" href="styles/kpiCards.css">
  <link rel="stylesheet" href="styles/dateFilter.css">
  <link rel="stylesheet" href="styles/tooltips.css">
  <link rel="stylesheet" href="styles/pagination.css">
  <link rel="stylesheet" href="styles/patternBadges.css">
  
  <!-- Script to expose module functions globally -->
  <script type="module">
    // Import dashboard functions
    import { showTab, toggleCard, filterByErrorType, toggleAutoRefresh } from './scripts/dashboard.js';
    import { applyQuickFilter as moduleApplyQuickFilter, toggleQuickFilterDropdown as moduleToggleQuickFilterDropdown, resetDateFilter as moduleResetDateFilter, shiftDateRange as moduleShiftDateRange, applyDateFilter as moduleApplyDateFilter } from './components/widgets/dateFilter.js';
    
    // Expose functions to global scope for inline event handlers
    window.showTab = showTab;
    window.toggleCard = toggleCard;
    window.filterByErrorType = filterByErrorType;
    window.toggleAutoRefresh = toggleAutoRefresh;
    
    // Create wrapper functions for date filter functions to handle the different signatures
    // The HTML inline handlers expect different parameters than our modular functions
    window.applyQuickFilter = function(value, unit) {
      console.log('Quick filter applied:', value, unit);
      
      // Create a callback function that applies filters and updates UI
      const onFilterChange = function(startDate, endDate) {
        console.log('Filter changed:', startDate, endDate);
        
        // Update global date range variables in dashboard.js
        window.startDate = startDate;
        window.endDate = endDate;
        
        // Call the applyFilters and updateUI functions from dashboard.js
        if (typeof window.applyFilters === 'function') {
          console.log('Calling applyFilters');
          window.applyFilters();
        } else {
          console.error('applyFilters is not available on window object');
        }
        
        if (typeof window.updateUI === 'function') {
          console.log('Calling updateUI');
          window.updateUI();
        } else {
          console.error('updateUI is not available on window object');
        }
      };
      
      // Call the modular function with the callback
      moduleApplyQuickFilter(value, unit, onFilterChange);
    };
    
    window.toggleQuickFilterDropdown = function(event) {
      moduleToggleQuickFilterDropdown(event);
    };
    
    window.resetDateFilter = function() {
      moduleResetDateFilter(function(startDate, endDate) {
        window.startDate = startDate;
        window.endDate = endDate;
        if (window.applyFilters) window.applyFilters();
        if (window.updateUI) window.updateUI();
      });
    };
    
    window.shiftDateRange = function(direction) {
      moduleShiftDateRange(direction, function(startDate, endDate) {
        window.startDate = startDate;
        window.endDate = endDate;
        if (window.applyFilters) window.applyFilters();
        if (window.updateUI) window.updateUI();
      });
    };
    
    window.applyDateFilter = function() {
      moduleApplyDateFilter(function(startDate, endDate) {
        window.startDate = startDate;
        window.endDate = endDate;
        if (window.applyFilters) window.applyFilters();
        if (window.updateUI) window.updateUI();
      });
    };
  </script>
</head>
<body>
  <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
    <!-- Header Component (will be loaded via JavaScript) -->
    <div id="header-container"></div>

    <main class="mdl-layout__content">
      <div class="page-content">
        <div id="lastUpdate" class="mdl-shadow--2dp"><i class="material-icons">update</i>Letzte Aktualisierung: --.--.---- --:--:--</div>
        
        <!-- Filter für Zeitraum -->
        <div id="sidebar-container" class="filter-header mdl-shadow--2dp">
          <!-- Sidebar will be loaded here -->
        </div>
        
        <div class="filter-container mdl-shadow--2dp" id="filterContent" style="padding: 16px; background-color: var(--card-bg-color); display: flex; justify-content: center; align-items: flex-start;">
          <!-- Date filter content will be loaded here -->
        </div>

        <!-- Übersicht Tab -->
        <div id="overview" class="tab-container active">
          <!-- Zusammenfassung -->
          <div class="mdl-grid summary-card mdl-shadow--2dp">
            <div class="summary-item">
              <div class="summary-value" id="totalFiles">-</div>
              <div class="summary-label">Dateien verarbeitet</div>
            </div>
            <div class="summary-item">
              <div class="summary-value" id="inputFiles">-</div>
              <div class="summary-label">Input-Dateien</div>
            </div>
            <div class="summary-item">
              <div class="summary-value" id="archiveFiles">-</div>
              <div class="summary-label">Archiv-Dateien</div>
            </div>
            <div class="summary-item">
              <div class="summary-value" id="errorFiles">-</div>
              <div class="summary-label">Fehler-Dateien</div>
            </div>
            <div class="summary-item">
              <div class="summary-value" id="totalErrors">-</div>
              <div class="summary-label">Fehler gesamt</div>
            </div>
            <div class="summary-item">
              <div class="summary-value" id="patternMatches">-</div>
              <div class="summary-label">Muster erkannt</div>
            </div>
            <div class="summary-item">
              <div class="summary-value" id="errorRate">-</div>
              <div class="summary-label">Fehlerrate</div>
            </div>
            <div class="summary-item">
              <div class="summary-value" id="avgThroughput">-</div>
              <div class="summary-label">Durchsatz/Stunde</div>
            </div>
          </div>

          <!-- KPI Cards - Container for modular component -->
          <div id="kpi-grid-container"></div>

          <div class="mdl-grid">
            <div class="mdl-cell mdl-cell--4-col">
              <div id="healthCard" class="mdl-card mdl-shadow--2dp">
                <!-- Widget A will be loaded here -->
              </div>
            </div>
            <div class="mdl-cell mdl-cell--8-col">
              <div id="topErrorsCard" class="mdl-card mdl-shadow--2dp">
                <div class="mdl-card__title">
                  <h2 class="mdl-card__title-text">Top Fehler</h2>
                  <button class="mdl-button mdl-js-button mdl-button--icon toggle-card-btn" onclick="toggleCard('topErrorsCard')" title="Ein-/ausklappen">
                    <i class="material-icons">expand_less</i>
                  </button>
                </div>
                <div class="mdl-card__supporting-text">
                  <div id="topErrorsList"></div>
                </div>
              </div>
            </div>
          </div>

          <div id="errorsByHourCard" class="mdl-card mdl-shadow--2dp">
            <div class="mdl-card__title">
              <h2 class="mdl-card__title-text">Fehler nach Tageszeit</h2>
              <button class="mdl-button mdl-js-button mdl-button--icon toggle-card-btn" onclick="toggleCard('errorsByHourCard')" title="Ein-/ausklappen">
                <i class="material-icons">expand_less</i>
              </button>
            </div>
            <div class="mdl-card__supporting-text">
              <div class="chart-container">
                <canvas id="errorsByHourChart"></canvas>
              </div>
            </div>
          </div>
          
          <!-- Error Stacked Line Chart -->
          <div id="errorStackedLineCard" class="mdl-card mdl-shadow--2dp">
            <div class="mdl-card__title">
              <h2 class="mdl-card__title-text">Fehlertypen-Verlauf</h2>
              <button class="mdl-button mdl-js-button mdl-button--icon toggle-card-btn" onclick="toggleCard('errorStackedLineCard')" title="Ein-/ausklappen">
                <i class="material-icons">expand_less</i>
              </button>
            </div>
            <div class="mdl-card__supporting-text">
              <div class="chart-container" style="height: 400px;">
                <canvas id="errorStackedLine"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Status Tab -->
        <div id="status" class="tab-container">
          <!-- Status-Diagramme - Aufgeteilt in drei separate Diagramme -->
          <div id="inputChartCard" class="mdl-card mdl-shadow--2dp">
            <div class="mdl-card__title">
              <h2 class="mdl-card__title-text">Eingangsstatistik</h2>
              <button class="mdl-button mdl-js-button mdl-button--icon toggle-card-btn" onclick="toggleCard('inputChartCard')" title="Ein-/ausklappen">
                <i class="material-icons">expand_less</i>
              </button>
            </div>
            <div class="mdl-card__supporting-text">
              <div class="chart-container">
                <canvas id="inputChart"></canvas>
              </div>
            </div>
          </div>

          <div id="throughputChartCard" class="mdl-card mdl-shadow--2dp">
            <div class="mdl-card__title">
              <h2 class="mdl-card__title-text">Durchsatz</h2>
              <button class="mdl-button mdl-js-button mdl-button--icon toggle-card-btn" onclick="toggleCard('throughputChartCard')" title="Ein-/ausklappen">
                <i class="material-icons">expand_less</i>
              </button>
            </div>
            <div class="mdl-card__supporting-text">
              <div class="chart-container">
                <canvas id="throughputChart"></canvas>
              </div>
            </div>
          </div>

          <div id="errorRateChartCard" class="mdl-card mdl-shadow--2dp">
            <div class="mdl-card__title">
              <h2 class="mdl-card__title-text">Fehlerrate</h2>
              <button class="mdl-button mdl-js-button mdl-button--icon toggle-card-btn" onclick="toggleCard('errorRateChartCard')" title="Ein-/ausklappen">
                <i class="material-icons">expand_less</i>
              </button>
            </div>
            <div class="mdl-card__supporting-text">
              <div class="chart-container">
                <canvas id="errorRateChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div id="analysis" class="tab-container">
          <!-- Fehler-Trend nach Typ -->
          <div id="errorTrendCard" class="mdl-card mdl-shadow--2dp">
            <div class="mdl-card__title">
              <h2 class="mdl-card__title-text">Fehler-Trend nach Typ</h2>
              <button class="mdl-button mdl-js-button mdl-button--icon toggle-card-btn" onclick="toggleCard('errorTrendCard')" title="Ein-/ausklappen">
                <i class="material-icons">expand_less</i>
              </button>
            </div>
            <div class="mdl-card__supporting-text">
              <div class="chart-container">
                <canvas id="errorTrendChart"></canvas>
              </div>
            </div>
          </div>

          <div id="errorsByWeekdayCard" class="mdl-card mdl-shadow--2dp">
            <div class="mdl-card__title">
              <h2 class="mdl-card__title-text">Fehler nach Wochentag</h2>
              <button class="mdl-button mdl-js-button mdl-button--icon toggle-card-btn" onclick="toggleCard('errorsByWeekdayCard')" title="Ein-/ausklappen">
                <i class="material-icons">expand_less</i>
              </button>
            </div>
            <div class="mdl-card__supporting-text">
              <div class="chart-container">
                <canvas id="errorsByWeekdayChart"></canvas>
              </div>
            </div>
          </div>

          <div id="errorTypeCard" class="mdl-card mdl-shadow--2dp">
            <div class="mdl-card__title">
              <h2 class="mdl-card__title-text">Fehlertypen</h2>
              <button class="mdl-button mdl-js-button mdl-button--icon toggle-card-btn" onclick="toggleCard('errorTypeCard')" title="Ein-/ausklappen">
                <i class="material-icons">expand_less</i>
              </button>
            </div>
            <div class="mdl-card__supporting-text">
              <div class="chart-container">
                <canvas id="errorTypePieChart"></canvas>
              </div>
            </div>
          </div>

        </div>
        
        <!-- Tables Tab -->
        <div id="tables" class="tab-container">
          <!-- Status Log Table -->
          <div id="statusTableCard" class="mdl-card mdl-shadow--2dp">
            <div class="mdl-card__title">
              <div style="display: flex; align-items: center;">
                <h2 class="mdl-card__title-text" style="margin-right: 5px;">Statusprotokoll</h2>
                <div class="tooltip">
                  <i class="material-icons info-icon" style="font-size: 16px; vertical-align: middle;">info_outline</i>
                  <span class="tooltiptext">Daten aus AFM_status_log.csv</span>
                </div>
              </div>
              <button class="mdl-button mdl-js-button mdl-button--icon toggle-card-btn" onclick="toggleCard('statusTableCard')" title="Ein-/ausklappen">
                <i class="material-icons">expand_less</i>
              </button>
            </div>
            <div class="mdl-card__supporting-text">
              <div class="search-container">
                <input type="text" id="statusSearch" class="search-input" placeholder="Suchen...">
                <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored search-button" onclick="searchStatus()">Suchen</button>
              </div>
              <div id="statusTable"></div>
            </div>
          </div>

          <!-- Error Log Table -->
          <div id="errorLogTableCard" class="mdl-card mdl-shadow--2dp">
            <div class="mdl-card__title">
              <div style="display: flex; align-items: center;">
                <h2 class="mdl-card__title-text" style="margin-right: 5px;">Fehlerprotokoll</h2>
                <div class="tooltip">
                  <i class="material-icons info-icon" style="font-size: 16px; vertical-align: middle;">info_outline</i>
                  <span class="tooltiptext">Daten aus AFM_error_log.csv</span>
                </div>
              </div>
              <button class="mdl-button mdl-js-button mdl-button--icon toggle-card-btn" onclick="toggleCard('errorLogTableCard')" title="Ein-/ausklappen">
                <i class="material-icons">expand_less</i>
              </button>
            </div>
            <div class="mdl-card__supporting-text">
              <div class="search-container">
                <input type="text" id="errorLogSearch" class="search-input" placeholder="Suchen...">
                <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored search-button" onclick="searchErrorLog()">Suchen</button>
              </div>
              <div id="errorLogTable"></div>
            </div>
          </div>

          <!-- Pattern Matches Table -->
          <div id="patternTableCard" class="mdl-card mdl-shadow--2dp">
            <div class="mdl-card__title">
              <div style="display: flex; align-items: center;">
                <h2 class="mdl-card__title-text" style="margin-right: 5px;">Fehlermuster</h2>
                <div class="tooltip">
                  <i class="material-icons info-icon" style="font-size: 16px; vertical-align: middle;">info_outline</i>
                  <span class="tooltiptext">Daten aus AFM_pattern_matches.csv</span>
                </div>
              </div>
              <button class="mdl-button mdl-js-button mdl-button--icon toggle-card-btn" onclick="toggleCard('patternTableCard')" title="Ein-/ausklappen">
                <i class="material-icons">expand_less</i>
              </button>
            </div>
            <div class="mdl-card__supporting-text">
              <div class="search-container">
                <input type="text" id="patternSearch" class="search-input" placeholder="Suchen...">
                <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored search-button" onclick="searchPatterns()">Suchen</button>
              </div>
              <div id="patternTable"></div>
            </div>
          </div>

          <!-- Input Details Table -->
          <div id="inputTableCard" class="mdl-card mdl-shadow--2dp">
            <div class="mdl-card__title">
              <div style="display: flex; align-items: center;">
                <h2 class="mdl-card__title-text" style="margin-right: 5px;">Eingabedetails</h2>
                <div class="tooltip">
                  <i class="material-icons info-icon" style="font-size: 16px; vertical-align: middle;">info_outline</i>
                  <span class="tooltiptext">Daten aus AFM_input_details.csv</span>
                </div>
              </div>
              <button class="mdl-button mdl-js-button mdl-button--icon toggle-card-btn" onclick="toggleCard('inputTableCard')" title="Ein-/ausklappen">
                <i class="material-icons">expand_less</i>
              </button>
            </div>
            <div class="mdl-card__supporting-text">
              <div class="search-container">
                <input type="text" id="inputSearch" class="search-input" placeholder="Suchen...">
                <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored search-button" onclick="searchInputs()">Suchen</button>
              </div>
              <div id="inputTable"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Refresh Button -->
  <div id="footer-container"></div>

  <!-- Load modular components -->
  <script type="module">
    // Import dashboard functions and expose them globally for onclick handlers
    import * as dashboard from './scripts/dashboard.js';
    
    // Expose functions to window object for inline onclick handlers
    window.toggleFilter = dashboard.toggleFilter;
    window.toggleCard = dashboard.toggleCard;
    window.applyQuickFilter = dashboard.applyQuickFilter;
    window.applyDateFilter = dashboard.applyDateFilter;
    window.resetDateFilter = dashboard.resetDateFilter;
    window.shiftDateRange = dashboard.shiftDateRange;
    window.adjustDate = dashboard.adjustDate;
    window.adjustTime = dashboard.adjustTime;
    window.searchErrors = function() {
      const searchInput = document.getElementById('errorSearch');
      if (searchInput) {
        console.log('Searching for:', searchInput.value);
        // Implement search functionality here
      }
    };
  </script>
</body>
</html>
